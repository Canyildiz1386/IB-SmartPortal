{% extends "base.html" %}

{% block title %}{{ session.title }}{% endblock %}

{% block content %}
<div style="max-width: 1600px; margin: 0 auto; padding: 24px;">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
        <div>
            <h1 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 600; color: #202124;">{{ session.title }}</h1>
            {% if session.subject_name %}
            <span style="display: inline-block; padding: 6px 16px; background: #e8f0fe; color: #1a73e8; border-radius: 16px; font-size: 14px; font-weight: 500;">{{ session.subject_name }}</span>
            {% endif %}
        </div>
        <a href="{{ url_for('study_together') }}" class="google-button secondary" style="text-decoration: none;">
            <span class="material-icons" style="font-size: 20px; margin-right: 8px;">arrow_back</span>
            Back to Sessions
        </a>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 350px; gap: 24px;">
        <div style="display: flex; flex-direction: column; gap: 24px;">
            <div style="background: white; padding: 24px; border-radius: 16px; border: 1px solid #e8eaed; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h2 style="margin: 0 0 16px 0; font-size: 20px; font-weight: 600; color: #202124;">Video & Audio</h2>
                <div id="videoContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; min-height: 400px; background: #000; border-radius: 12px; padding: 16px;">
                    <div id="localVideoContainer" style="position: relative; background: #1a1a1a; border-radius: 8px; overflow: hidden;">
                        <video id="localVideo" autoplay muted style="width: 100%; height: 100%; object-fit: cover;"></video>
                        <div style="position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">You</div>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 16px; justify-content: center; flex-wrap: wrap;">
                    <button id="toggleVideo" class="google-button" style="padding: 12px 20px;">
                        <span class="material-icons" style="font-size: 20px; margin-right: 8px;">videocam</span>
                        Video ON
                    </button>
                    <button id="toggleAudio" class="google-button" style="padding: 12px 20px;">
                        <span class="material-icons" style="font-size: 20px; margin-right: 8px;">mic</span>
                        Audio ON
                    </button>
                    <button id="toggleScreenShare" class="google-button" style="padding: 12px 20px; background: #34a853;">
                        <span class="material-icons" style="font-size: 20px; margin-right: 8px;">screen_share</span>
                        Share Screen
                    </button>
                    <button id="leaveSession" class="google-button" style="background: #ea4335; padding: 12px 20px;">
                        <span class="material-icons" style="font-size: 20px; margin-right: 8px;">call_end</span>
                        Leave
                    </button>
                </div>
            </div>

            <div style="background: white; padding: 24px; border-radius: 16px; border: 1px solid #e8eaed; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; flex-direction: column; height: 400px;">
                <h2 style="margin: 0 0 16px 0; font-size: 20px; font-weight: 600; color: #202124;">Chat</h2>
                <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 16px; background: #f8f9fa; border-radius: 8px; margin-bottom: 16px; display: flex; flex-direction: column; gap: 12px;">
                    {% for msg in messages %}
                    <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #e8eaed;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <span style="font-weight: 600; color: #1a73e8; font-size: 14px;">{{ msg.username }}</span>
                            <span style="color: #5f6368; font-size: 12px;">{{ msg.timestamp }}</span>
                        </div>
                        <p style="margin: 0; color: #202124; font-size: 14px;">{{ msg.message }}</p>
                    </div>
                    {% endfor %}
                </div>
                <div style="display: flex; gap: 12px;">
                    <input type="text" id="chatInput" placeholder="Type a message or /ai [question] to ask AI..." class="google-input" style="flex: 1;">
                    <button id="sendMessage" class="google-button" style="padding: 12px 20px;">
                        <span class="material-icons" style="font-size: 20px;">send</span>
                    </button>
                </div>
                <div style="margin-top: 8px; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; font-size: 12px; color: #5f6368;">
                    <span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 4px;">info</span>
                    Tip: Type <code style="background: #e8eaed; padding: 2px 6px; border-radius: 4px; font-family: monospace;">/ai</code> followed by your question to chat with AI
                </div>
            </div>
        </div>

        <div style="display: flex; flex-direction: column; gap: 24px;">
            <div style="background: white; padding: 24px; border-radius: 16px; border: 1px solid #e8eaed; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h2 style="margin: 0 0 16px 0; font-size: 20px; font-weight: 600; color: #202124;">Participants ({{ participants|length }})</h2>
                <div id="participantsList" style="display: flex; flex-direction: column; gap: 12px;">
                    {% for participant in participants %}
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                        <div style="width: 40px; height: 40px; background: {% if participant.role == 'teacher' %}#1a73e8{% elif participant.role == 'admin' %}#ea4335{% else %}#34a853{% endif %}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                            {{ participant.username[0].upper() }}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #202124; font-size: 14px;">{{ participant.username }}</div>
                            <div style="color: #5f6368; font-size: 12px;">{{ participant.role|title }}</div>
                        </div>
                        {% if participant.id == session.host_id %}
                        <span class="material-icons" style="font-size: 18px; color: #fbbc04;" title="Host">star</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            {% if session.description %}
            <div style="background: white; padding: 24px; border-radius: 16px; border: 1px solid #e8eaed; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h2 style="margin: 0 0 12px 0; font-size: 18px; font-weight: 600; color: #202124;">About</h2>
                <p style="margin: 0; color: #5f6368; font-size: 14px; line-height: 1.6;">{{ session.description }}</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
const sessionId = {{ session.id }};
const currentUserId = {{ user.id }};
const socket = io();
let localStream = null;
let screenShareStream = null;
let remoteStreams = {};
let isVideoEnabled = true;
let isAudioEnabled = true;
let isScreenSharing = false;
const pcConfig = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
    ]
};

socket.on('connect', function() {
    socket.emit('join_session', { session_id: sessionId });
});

socket.on('user_joined', function(data) {
    updateParticipants(data.participants);
    addChatMessage('System', `${data.username} joined the session`, true);
    if (localStream) {
        data.participants.forEach(participant => {
            if (participant.id !== currentUserId && !remoteStreams[participant.id]) {
                createPeerConnection(participant.id);
            }
        });
    }
});

socket.on('user_left', function(data) {
    updateParticipants(data.participants);
    addChatMessage('System', `${data.username} left the session`, true);
    data.participants.forEach(participant => {
        if (remoteStreams[participant.id]) {
            remoteStreams[participant.id].pc.close();
            const container = document.getElementById(`container_${participant.id}`);
            if (container) container.remove();
            delete remoteStreams[participant.id];
        }
    });
});

socket.on('new_message', function(data) {
    if (data.message.startsWith('/ai ')) {
        return;
    }
    addChatMessage(data.username, data.message, false);
});

socket.on('ai_response', function(data) {
    addChatMessage(data.username, `/ai ${data.question}`, false);
    setTimeout(() => {
        addChatMessage('AI Assistant', data.answer, false, true);
    }, 100);
});

socket.on('offer', function(data) {
    handleOffer(data);
});

socket.on('answer', function(data) {
    handleAnswer(data);
});

socket.on('ice_candidate', function(data) {
    handleIceCandidate(data);
});

async function startLocalVideo() {
    try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('localVideo').srcObject = localStream;
        socket.emit('ready_for_connections', { session_id: sessionId });
        setupPeerConnections();
    } catch (error) {
        console.error('Error accessing media devices:', error);
        alert('Could not access camera/microphone. Please check permissions.');
    }
}

function setupPeerConnections() {
    const initialParticipants = {{ participants|tojson }};
    initialParticipants.forEach(participant => {
        if (participant.id !== currentUserId) {
            createPeerConnection(participant.id);
        }
    });
}

function updateVideoLabels() {
    const allParticipants = {{ participants|tojson }};
    allParticipants.forEach(participant => {
        const label = document.getElementById(`label_${participant.id}`);
        if (label) {
            label.textContent = participant.username;
        }
    });
}

function createPeerConnection(userId) {
    if (remoteStreams[userId]) {
        return remoteStreams[userId].pc;
    }
    
    const pc = new RTCPeerConnection(pcConfig);
    
    localStream.getTracks().forEach(track => {
        pc.addTrack(track, localStream);
    });
    
    pc.onicecandidate = (event) => {
        if (event.candidate) {
            socket.emit('ice_candidate', {
                session_id: sessionId,
                target_user_id: userId,
                candidate: event.candidate
            });
        }
    };
    
    pc.ontrack = (event) => {
        const stream = event.streams[0];
        const videoId = `video_${userId}`;
        let remoteVideo = document.getElementById(videoId);
        
        if (!remoteVideo) {
            remoteVideo = document.createElement('video');
            remoteVideo.id = videoId;
            remoteVideo.autoplay = true;
            remoteVideo.playsInline = true;
            remoteVideo.style.width = '100%';
            remoteVideo.style.height = '100%';
            remoteVideo.style.objectFit = 'cover';
            
            const container = document.createElement('div');
            container.id = `container_${userId}`;
            container.style.position = 'relative';
            container.style.background = '#1a1a1a';
            container.style.borderRadius = '8px';
            container.style.overflow = 'hidden';
            container.appendChild(remoteVideo);
            
            const label = document.createElement('div');
            label.style.position = 'absolute';
            label.style.bottom = '8px';
            label.style.left = '8px';
            label.style.background = 'rgba(0,0,0,0.7)';
            label.style.color = 'white';
            label.style.padding = '4px 8px';
            label.style.borderRadius = '4px';
            label.style.fontSize = '12px';
            label.id = `label_${userId}`;
            label.textContent = 'Connecting...';
            container.appendChild(label);
            
            document.getElementById('videoContainer').appendChild(container);
        }
        
        remoteVideo.srcObject = stream;
        remoteStreams[userId] = { pc, video: remoteVideo };
        updateVideoLabels();
        
        const label = document.getElementById(`label_${userId}`);
        if (label) {
            label.textContent = 'Connected';
            setTimeout(() => {
                if (label) label.style.display = 'none';
            }, 2000);
        }
    };
    
    pc.onconnectionstatechange = () => {
        const label = document.getElementById(`label_${userId}`);
        if (label) {
            if (pc.connectionState === 'connected') {
                label.textContent = 'Connected';
                setTimeout(() => {
                    if (label) label.style.display = 'none';
                }, 2000);
            } else if (pc.connectionState === 'connecting') {
                label.textContent = 'Connecting...';
            } else if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
                label.textContent = 'Disconnected';
            }
        }
    };
    
    remoteStreams[userId] = { pc };
    
    pc.createOffer({ offerToReceiveAudio: true, offerToReceiveVideo: true }).then(offer => {
        pc.setLocalDescription(offer).then(() => {
            socket.emit('offer', {
                session_id: sessionId,
                target_user_id: userId,
                offer: offer
            });
        }).catch(err => console.error('Error setting local description:', err));
    }).catch(err => console.error('Error creating offer:', err));
    
    return pc;
}

function handleOffer(data) {
    const userId = data.user_id || data.target_user_id;
    if (!userId || userId === currentUserId) return;
    
    if (!localStream) {
        setTimeout(() => handleOffer(data), 500);
        return;
    }
    
    let pc = remoteStreams[userId]?.pc;
    if (!pc) {
        pc = new RTCPeerConnection(pcConfig);
        localStream.getTracks().forEach(track => {
            pc.addTrack(track, localStream);
        });
        
        pc.onicecandidate = (event) => {
            if (event.candidate) {
                socket.emit('ice_candidate', {
                    session_id: sessionId,
                    target_user_id: userId,
                    candidate: event.candidate
                });
            }
        };
        
        pc.ontrack = (event) => {
            const stream = event.streams[0];
            const videoId = `video_${userId}`;
            let remoteVideo = document.getElementById(videoId);
            
            if (!remoteVideo) {
                remoteVideo = document.createElement('video');
                remoteVideo.id = videoId;
                remoteVideo.autoplay = true;
                remoteVideo.playsInline = true;
                remoteVideo.style.width = '100%';
                remoteVideo.style.height = '100%';
                remoteVideo.style.objectFit = 'cover';
                
                const container = document.createElement('div');
                container.id = `container_${userId}`;
                container.style.position = 'relative';
                container.style.background = '#1a1a1a';
                container.style.borderRadius = '8px';
                container.style.overflow = 'hidden';
                container.appendChild(remoteVideo);
                
                const label = document.createElement('div');
                label.style.position = 'absolute';
                label.style.bottom = '8px';
                label.style.left = '8px';
                label.style.background = 'rgba(0,0,0,0.7)';
                label.style.color = 'white';
                label.style.padding = '4px 8px';
                label.style.borderRadius = '4px';
                label.style.fontSize = '12px';
                label.id = `label_${userId}`;
                label.textContent = 'Connecting...';
                container.appendChild(label);
                
                document.getElementById('videoContainer').appendChild(container);
            }
            
            remoteVideo.srcObject = stream;
            remoteStreams[userId] = { pc, video: remoteVideo };
            updateVideoLabels();
            
            const label = document.getElementById(`label_${userId}`);
            if (label) {
                label.textContent = 'Connected';
                setTimeout(() => {
                    if (label) label.style.display = 'none';
                }, 2000);
            }
        };
        
        pc.onconnectionstatechange = () => {
            const label = document.getElementById(`label_${userId}`);
            if (label) {
                if (pc.connectionState === 'connected') {
                    label.textContent = 'Connected';
                    setTimeout(() => {
                        if (label) label.style.display = 'none';
                    }, 2000);
                } else if (pc.connectionState === 'connecting') {
                    label.textContent = 'Connecting...';
                } else if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
                    label.textContent = 'Disconnected';
                }
            }
        };
        
        remoteStreams[userId] = { pc };
    }
    
    pc.setRemoteDescription(new RTCSessionDescription(data.offer)).then(() => {
        pc.createAnswer({ offerToReceiveAudio: true, offerToReceiveVideo: true }).then(answer => {
            pc.setLocalDescription(answer).then(() => {
                socket.emit('answer', {
                    session_id: sessionId,
                    target_user_id: userId,
                    answer: answer
                });
            }).catch(err => console.error('Error setting local description:', err));
        }).catch(err => console.error('Error creating answer:', err));
    }).catch(err => console.error('Error setting remote description:', err));
}

function handleAnswer(data) {
    const userId = data.user_id || data.target_user_id;
    if (remoteStreams[userId] && remoteStreams[userId].pc) {
        remoteStreams[userId].pc.setRemoteDescription(new RTCSessionDescription(data.answer))
            .catch(err => console.error('Error setting remote description:', err));
    }
}

function handleIceCandidate(data) {
    const userId = data.user_id || data.target_user_id;
    if (remoteStreams[userId] && remoteStreams[userId].pc && data.candidate) {
        remoteStreams[userId].pc.addIceCandidate(new RTCIceCandidate(data.candidate))
            .catch(err => console.error('Error adding ICE candidate:', err));
    }
}

socket.on('ready_for_connections', function(data) {
    if (localStream && data.user_id !== currentUserId) {
        if (!remoteStreams[data.user_id]) {
            createPeerConnection(data.user_id);
        }
    }
});

document.getElementById('toggleVideo').addEventListener('click', function() {
    isVideoEnabled = !isVideoEnabled;
    const stream = isScreenSharing && screenShareStream ? screenShareStream : localStream;
    if (stream) {
        stream.getVideoTracks().forEach(track => {
            track.enabled = isVideoEnabled;
        });
    }
    this.innerHTML = isVideoEnabled 
        ? '<span class="material-icons" style="font-size: 20px; margin-right: 8px;">videocam</span>Video ON'
        : '<span class="material-icons" style="font-size: 20px; margin-right: 8px;">videocam_off</span>Video OFF';
    this.style.background = isVideoEnabled ? '#1a73e8' : '#5f6368';
});

document.getElementById('toggleAudio').addEventListener('click', function() {
    isAudioEnabled = !isAudioEnabled;
    const stream = isScreenSharing && screenShareStream ? screenShareStream : localStream;
    if (stream) {
        stream.getAudioTracks().forEach(track => {
            track.enabled = isAudioEnabled;
        });
    }
    this.innerHTML = isAudioEnabled
        ? '<span class="material-icons" style="font-size: 20px; margin-right: 8px;">mic</span>Audio ON'
        : '<span class="material-icons" style="font-size: 20px; margin-right: 8px;">mic_off</span>Audio OFF';
    this.style.background = isAudioEnabled ? '#1a73e8' : '#5f6368';
});

document.getElementById('toggleScreenShare').addEventListener('click', async function() {
    if (!isScreenSharing) {
        try {
            screenShareStream = await navigator.mediaDevices.getDisplayMedia({ 
                video: true, 
                audio: true 
            });
            
            const videoTrack = screenShareStream.getVideoTracks()[0];
            const audioTrack = screenShareStream.getAudioTracks()[0];
            
            Object.values(remoteStreams).forEach(({ pc }) => {
                const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
                if (sender && videoTrack) {
                    sender.replaceTrack(videoTrack);
                }
                
                if (audioTrack) {
                    const audioSender = pc.getSenders().find(s => s.track && s.track.kind === 'audio');
                    if (audioSender) {
                        audioSender.replaceTrack(audioTrack);
                    } else {
                        pc.addTrack(audioTrack, screenShareStream);
                    }
                }
            });
            
            document.getElementById('localVideo').srcObject = screenShareStream;
            isScreenSharing = true;
            this.innerHTML = '<span class="material-icons" style="font-size: 20px; margin-right: 8px;">stop_screen_share</span>Stop Sharing';
            this.style.background = '#ea4335';
            
            videoTrack.onended = () => {
                stopScreenShare();
            };
            
        } catch (error) {
            console.error('Error starting screen share:', error);
            alert('Could not start screen sharing. Please check permissions.');
        }
    } else {
        stopScreenShare();
    }
});

function stopScreenShare() {
    if (screenShareStream) {
        screenShareStream.getTracks().forEach(track => track.stop());
        screenShareStream = null;
    }
    
    if (localStream) {
        const videoTrack = localStream.getVideoTracks()[0];
        const audioTrack = localStream.getAudioTracks()[0];
        
        Object.values(remoteStreams).forEach(({ pc }) => {
            const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
            if (sender && videoTrack) {
                sender.replaceTrack(videoTrack);
            }
            
            const audioSender = pc.getSenders().find(s => s.track && s.track.kind === 'audio');
            if (audioSender && audioTrack) {
                audioSender.replaceTrack(audioTrack);
            }
        });
        
        document.getElementById('localVideo').srcObject = localStream;
    }
    
    isScreenSharing = false;
    const shareBtn = document.getElementById('toggleScreenShare');
    shareBtn.innerHTML = '<span class="material-icons" style="font-size: 20px; margin-right: 8px;">screen_share</span>Share Screen';
    shareBtn.style.background = '#34a853';
}

document.getElementById('sendMessage').addEventListener('click', sendMessage);
document.getElementById('chatInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (message) {
        socket.emit('send_message', {
            session_id: sessionId,
            message: message
        });
        input.value = '';
    }
}

function addChatMessage(username, message, isSystem, isAI = false) {
    const chatContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    
    if (isAI) {
        messageDiv.style.background = '#e8f5e9';
        messageDiv.style.borderLeft = '4px solid #34a853';
    } else {
        messageDiv.style.background = isSystem ? '#e8f0fe' : 'white';
    }
    
    messageDiv.style.padding = '12px';
    messageDiv.style.borderRadius = '8px';
    messageDiv.style.border = '1px solid #e8eaed';
    
    const header = document.createElement('div');
    header.style.display = 'flex';
    header.style.alignItems = 'center';
    header.style.gap = '8px';
    header.style.marginBottom = '4px';
    
    if (isAI) {
        const aiIcon = document.createElement('span');
        aiIcon.className = 'material-icons';
        aiIcon.style.fontSize = '16px';
        aiIcon.style.color = '#34a853';
        aiIcon.textContent = 'smart_toy';
        header.appendChild(aiIcon);
    }
    
    const usernameSpan = document.createElement('span');
    usernameSpan.style.fontWeight = '600';
    if (isAI) {
        usernameSpan.style.color = '#34a853';
    } else {
        usernameSpan.style.color = isSystem ? '#5f6368' : '#1a73e8';
    }
    usernameSpan.style.fontSize = '14px';
    usernameSpan.textContent = username;
    header.appendChild(usernameSpan);
    
    const timeSpan = document.createElement('span');
    timeSpan.style.color = '#5f6368';
    timeSpan.style.fontSize = '12px';
    timeSpan.textContent = new Date().toLocaleTimeString();
    header.appendChild(timeSpan);
    
    const messageP = document.createElement('p');
    messageP.style.margin = '0';
    messageP.style.color = '#202124';
    messageP.style.fontSize = '14px';
    messageP.style.whiteSpace = 'pre-wrap';
    messageP.style.wordWrap = 'break-word';
    messageP.textContent = message;
    
    messageDiv.appendChild(header);
    messageDiv.appendChild(messageP);
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function updateParticipants(participantsList) {
    const container = document.getElementById('participantsList');
    container.innerHTML = '';
    const hostId = {{ session.host_id }};
    participantsList.forEach(participant => {
        const div = document.createElement('div');
        div.style.display = 'flex';
        div.style.alignItems = 'center';
        div.style.gap = '12px';
        div.style.padding = '12px';
        div.style.background = '#f8f9fa';
        div.style.borderRadius = '8px';
        
        const avatar = document.createElement('div');
        avatar.style.width = '40px';
        avatar.style.height = '40px';
        avatar.style.background = participant.role === 'teacher' ? '#1a73e8' : participant.role === 'admin' ? '#ea4335' : '#34a853';
        avatar.style.borderRadius = '50%';
        avatar.style.display = 'flex';
        avatar.style.alignItems = 'center';
        avatar.style.justifyContent = 'center';
        avatar.style.color = 'white';
        avatar.style.fontWeight = '600';
        avatar.textContent = participant.username[0].toUpperCase();
        
        const info = document.createElement('div');
        info.style.flex = '1';
        const name = document.createElement('div');
        name.style.fontWeight = '600';
        name.style.color = '#202124';
        name.style.fontSize = '14px';
        name.textContent = participant.username;
        const role = document.createElement('div');
        role.style.color = '#5f6368';
        role.style.fontSize = '12px';
        role.textContent = participant.role.charAt(0).toUpperCase() + participant.role.slice(1);
        info.appendChild(name);
        info.appendChild(role);
        
        div.appendChild(avatar);
        div.appendChild(info);
        
        if (participant.id === hostId) {
            const star = document.createElement('span');
            star.className = 'material-icons';
            star.style.fontSize = '18px';
            star.style.color = '#fbbc04';
            star.textContent = 'star';
            star.title = 'Host';
            div.appendChild(star);
        }
        
        container.appendChild(div);
    });
}

document.getElementById('leaveSession').addEventListener('click', function() {
    if (confirm('Are you sure you want to leave this session?')) {
        socket.emit('leave_session', { session_id: sessionId });
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
        }
        if (screenShareStream) {
            screenShareStream.getTracks().forEach(track => track.stop());
        }
        Object.values(remoteStreams).forEach(stream => {
            stream.pc.close();
        });
        window.location.href = '{{ url_for("study_together") }}';
    }
});

window.addEventListener('beforeunload', function() {
    socket.emit('leave_session', { session_id: sessionId });
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
    }
    if (screenShareStream) {
        screenShareStream.getTracks().forEach(track => track.stop());
    }
});

startLocalVideo();
updateVideoLabels();
</script>
{% endblock %}

