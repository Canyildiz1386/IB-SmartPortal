{% extends "base.html" %}
{% block title %}AI Chat - Smart Study{% endblock %}
{% block content %}
<h2>AI Chat</h2>
<div class="card">
    <div class="card-body">
        <div id="chatMessages" style="height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; background: #f9f9f9;">
            {% for msg in chat_history %}
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <strong>You:</strong> {{ msg.question }}<br>
                        <strong>AI:</strong> {{ msg.answer }}
                        {% if msg.sources %}
                        <div class="mt-2">
                            <small class="text-muted">
                                <strong>Sources:</strong>
                                {% for source in msg.sources %}
                                <span class="badge bg-info me-1">{{ source.metadata.get('file', 'Unknown') }} ({{ "%.1f"|format(source.score * 100) }}%)</span>
                                {% endfor %}
                            </small>
                        </div>
                        {% endif %}
                        {% if msg.confidence is defined %}
                        <div class="mt-1">
                            <small class="badge {% if msg.confidence > 0.7 %}bg-success{% elif msg.confidence > 0.4 %}bg-warning{% else %}bg-danger{% endif %}">
                                Confidence: {{ "%.1f"|format(msg.confidence * 100) }}%
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <form method="POST" id="chatForm">
            <div class="input-group">
                <input type="text" name="question" class="form-control" placeholder="Ask a question..." required>
                <button type="submit" class="btn btn-primary">Send</button>
            </div>
        </form>
    </div>
</div>
<script>
document.getElementById('chatForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const question = formData.get('question');
    const messagesDiv = document.getElementById('chatMessages');
    
    if (!question.trim()) {
        return;
    }
    
    messagesDiv.innerHTML += '<div class="mb-3"><strong>You:</strong> ' + escapeHtml(question) + '</div>';
    this.querySelector('input').value = '';
    
    const loadingId = 'loading-' + Date.now();
    const loadingHtml = `
        <div class="mb-3" id="${loadingId}">
            <strong>AI:</strong> 
            <span class="thinking-indicator">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Thinking...
                <span class="thinking-dots">
                    <span>.</span><span>.</span><span>.</span>
                </span>
            </span>
        </div>
    `;
    messagesDiv.innerHTML += loadingHtml;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    fetch('/chat', {
        method: 'POST',
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const loadingElement = document.getElementById(loadingId);
        if (loadingElement) {
            loadingElement.remove();
        }
        
        if (data.success) {
            let sourcesHtml = '';
            if (data.sources && data.sources.length > 0) {
                sourcesHtml = '<div class="mt-2"><small class="text-muted"><strong>Sources:</strong> ';
                data.sources.forEach(source => {
                    const fileName = source.metadata && source.metadata.file ? source.metadata.file : 'Unknown';
                    const score = (source.score * 100).toFixed(1);
                    sourcesHtml += `<span class="badge bg-info me-1">${fileName} (${score}%)</span>`;
                });
                sourcesHtml += '</small></div>';
            }
            
            let confidenceHtml = '';
            if (data.confidence !== undefined) {
                const confClass = data.confidence > 70 ? 'bg-success' : data.confidence > 40 ? 'bg-warning' : 'bg-danger';
                confidenceHtml = `<div class="mt-1"><small class="badge ${confClass}">Confidence: ${data.confidence}%</small></div>`;
            }
            
            messagesDiv.innerHTML += `<div class="mb-3"><strong>AI:</strong> ${escapeHtml(data.answer)}${sourcesHtml}${confidenceHtml}</div>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        } else {
            messagesDiv.innerHTML += `<div class="mb-3 text-danger"><strong>AI:</strong> Error: ${escapeHtml(data.error || 'Something went wrong')}</div>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        const loadingElement = document.getElementById(loadingId);
        if (loadingElement) {
            loadingElement.remove();
        }
        messagesDiv.innerHTML += `<div class="mb-3 text-danger"><strong>AI:</strong> An error occurred. Please try again.</div>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
});

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
<style>
.thinking-indicator {
    display: inline-flex;
    align-items: center;
    color: #6c757d;
    font-style: italic;
}

.thinking-dots span {
    animation: thinking 1.4s infinite;
    opacity: 0;
}

.thinking-dots span:nth-child(1) {
    animation-delay: 0s;
}

.thinking-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.thinking-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes thinking {
    0%, 60%, 100% {
        opacity: 0;
    }
    30% {
        opacity: 1;
    }
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
    border-width: 0.15em;
}
</style>
{% endblock %}
