{% extends "base.html" %}
{% block title %}My Notes - Smart Study{% endblock %}
{% block content %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<h2>My Notes</h2>

<div class="row">
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>My Notes</span>
                <button class="btn btn-sm btn-primary" onclick="createNewNote()">+ New Note</button>
            </div>
            <div class="card-body p-2">
                <select class="form-select form-select-sm mb-2" onchange="filterBySubject(this.value)">
                    <option value="">All Subjects</option>
                    {% for subject in subjects %}
                    <option value="{{ subject.id }}" {% if filter_subject == subject.id %}selected{% endif %}>{{ subject.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="list-group list-group-flush" style="max-height: 600px; overflow-y: auto;">
                {% for note in notes %}
                <a href="#" class="list-group-item list-group-item-action note-item" 
                   data-note-id="{{ note.id }}" 
                   data-note-title="{{ note.title|e }}" 
                   data-note-content="{{ note.content|e }}"
                   data-note-subject="{{ note.subject_id or '' }}">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">{{ note.title }}</h6>
                        <small>{{ note.updated_at[:10] }}</small>
                    </div>
                    {% if note.subject_name %}
                    <small class="badge bg-secondary mb-1">{{ note.subject_name }}</small>
                    {% endif %}
                    <p class="mb-1 text-muted" style="font-size: 0.85em;">{{ (note.content or '')[:50]|striptags }}{% if note.content and note.content|length > 50 %}...{% endif %}</p>
                </a>
                {% endfor %}
                {% if not notes %}
                <div class="list-group-item text-muted text-center">No notes yet. Create one!</div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <span id="noteTitle">Create or Select a Note</span>
                    <div>
                        <button id="voiceBtn" class="btn btn-sm btn-success" onclick="toggleVoiceRecognition()" style="display:none;">
                            <span id="voiceIcon">ðŸŽ¤</span> <span id="voiceStatus">Start Voice</span>
                        </button>
                        <button id="saveBtn" class="btn btn-sm btn-primary" onclick="saveNote()" style="display:none;">Save</button>
                        <button id="deleteBtn" class="btn btn-sm btn-danger" onclick="deleteNote()" style="display:none;">Delete</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <form id="noteForm" method="POST" style="display:none;">
                    <input type="hidden" name="action" id="formAction" value="create">
                    <input type="hidden" name="note_id" id="noteId">
                    <div class="mb-3">
                        <input type="text" name="title" id="noteTitleInput" class="form-control" placeholder="Note Title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Subject</label>
                        <select name="subject_id" id="noteSubjectSelect" class="form-select">
                            <option value="">No Subject</option>
                            {% for subject in subjects %}
                            <option value="{{ subject.id }}">{{ subject.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <div id="editor-container" style="height: 400px;"></div>
                        <textarea name="content" id="noteContent" style="display:none;"></textarea>
                    </div>
                </form>
                <div id="emptyState" class="text-center text-muted py-5">
                    <p>Select a note from the list or create a new one to start taking notes.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
let currentNoteId = null;
let recognition = null;
let isRecording = false;
let autoSaveTimer = null;
let quill = null;

const toolbarOptions = [
    [{ 'header': [1, 2, 3, false] }],
    ['bold', 'italic', 'underline', 'strike'],
    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
    [{ 'align': [] }],
    ['link'],
    ['clean']
];

quill = new Quill('#editor-container', {
    theme: 'snow',
    modules: {
        toolbar: toolbarOptions
    }
});

quill.on('text-change', function() {
    updateContent();
    autoSave();
});

if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-US';
    
    recognition.onresult = function(event) {
        let interimTranscript = '';
        let finalTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcript + ' ';
            } else {
                interimTranscript += transcript;
            }
        }
        
        if (finalTranscript) {
            quill.insertText(quill.getLength() - 1, finalTranscript);
            updateContent();
        }
    };
    
    recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        if (event.error === 'no-speech') {
            stopVoiceRecognition();
        }
    };
    
    recognition.onend = function() {
        if (isRecording) {
            recognition.start();
        }
    };
} else {
    document.getElementById('voiceBtn').disabled = true;
    document.getElementById('voiceBtn').title = 'Voice recognition not supported in this browser';
}

function filterBySubject(subjectId) {
    const url = new URL(window.location.href);
    if (subjectId) {
        url.searchParams.set('subject_id', subjectId);
    } else {
        url.searchParams.delete('subject_id');
    }
    window.location.href = url.toString();
}

function toggleVoiceRecognition() {
    if (!recognition) {
        alert('Voice recognition is not supported in your browser.');
        return;
    }
    
    if (isRecording) {
        stopVoiceRecognition();
    } else {
        startVoiceRecognition();
    }
}

function startVoiceRecognition() {
    if (!recognition) return;
    try {
        recognition.start();
        isRecording = true;
        document.getElementById('voiceStatus').textContent = 'Stop Voice';
        document.getElementById('voiceIcon').textContent = 'â¹';
        document.getElementById('voiceBtn').classList.remove('btn-success');
        document.getElementById('voiceBtn').classList.add('btn-danger');
    } catch (e) {
        console.error('Error starting recognition:', e);
    }
}

function stopVoiceRecognition() {
    if (!recognition) return;
    recognition.stop();
    isRecording = false;
    document.getElementById('voiceStatus').textContent = 'Start Voice';
    document.getElementById('voiceIcon').textContent = 'ðŸŽ¤';
    document.getElementById('voiceBtn').classList.remove('btn-danger');
    document.getElementById('voiceBtn').classList.add('btn-success');
}

function updateContent() {
    const content = document.getElementById('noteContent');
    content.value = quill.root.innerHTML;
}

function autoSave() {
    updateContent();
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(() => {
        if (currentNoteId) {
            saveNote(true);
        }
    }, 2000);
}

function createNewNote() {
    currentNoteId = null;
    document.getElementById('noteTitle').textContent = 'New Note';
    document.getElementById('noteTitleInput').value = '';
    quill.setContents([]);
    document.getElementById('noteContent').value = '';
    document.getElementById('noteSubjectSelect').value = '';
    document.getElementById('noteForm').style.display = 'block';
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('saveBtn').style.display = 'inline-block';
    document.getElementById('deleteBtn').style.display = 'none';
    document.getElementById('voiceBtn').style.display = 'inline-block';
    document.getElementById('formAction').value = 'create';
    document.getElementById('noteId').value = '';
    document.getElementById('noteTitleInput').focus();
}

function loadNote(id, title, content, subjectId, element) {
    currentNoteId = id;
    document.getElementById('noteTitle').textContent = title;
    document.getElementById('noteTitleInput').value = title;
    document.getElementById('noteSubjectSelect').value = subjectId || '';
    
    if (content) {
        quill.root.innerHTML = content;
    } else {
        quill.setContents([]);
    }
    
    updateContent();
    document.getElementById('noteForm').style.display = 'block';
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('saveBtn').style.display = 'inline-block';
    document.getElementById('deleteBtn').style.display = 'inline-block';
    document.getElementById('voiceBtn').style.display = 'inline-block';
    document.getElementById('formAction').value = 'update';
    document.getElementById('noteId').value = id;
    
    document.querySelectorAll('.list-group-item').forEach(item => {
        item.classList.remove('active');
    });
    if (element) {
        element.classList.add('active');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.note-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const id = parseInt(this.getAttribute('data-note-id'));
            const title = this.getAttribute('data-note-title');
            const content = this.getAttribute('data-note-content');
            const subjectId = this.getAttribute('data-note-subject');
            loadNote(id, title, content, subjectId, this);
        });
    });
});

function saveNote(silent = false) {
    const title = document.getElementById('noteTitleInput').value.trim();
    if (!title) {
        if (!silent) alert('Please enter a title');
        return;
    }
    
    updateContent();
    const form = document.getElementById('noteForm');
    
    if (silent) {
        const formData = new FormData(form);
        fetch(window.location.href, {
            method: 'POST',
            body: formData
        }).then(() => {
            console.log('Auto-saved');
        }).catch(err => {
            console.error('Auto-save error:', err);
        });
    } else {
        form.submit();
    }
}

function deleteNote() {
    if (!currentNoteId) return;
    if (!confirm('Are you sure you want to delete this note?')) return;
    
    const form = document.getElementById('noteForm');
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'delete';
    form.appendChild(actionInput);
    
    const noteIdInput = document.createElement('input');
    noteIdInput.type = 'hidden';
    noteIdInput.name = 'note_id';
    noteIdInput.value = currentNoteId;
    form.appendChild(noteIdInput);
    
    form.submit();
}
</script>

<style>
.list-group-item.active {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
}

.list-group-item.active .text-muted {
    color: rgba(255, 255, 255, 0.8) !important;
}

.list-group-item.active .badge {
    background-color: rgba(255, 255, 255, 0.3) !important;
}
</style>
{% endblock %}
