{% extends "base.html" %}

{% block title %}Notes{% endblock %}
{% block page_title %}Notes{% endblock %}

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
        transform: scale(1);
    }
    50% {
        opacity: 0.6;
        transform: scale(1.2);
    }
}

.markdown-content img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 12px 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
</style>

{% block content %}
<!-- Header Section -->
<div style="background: white; padding: 32px; margin-bottom: 24px; border-radius: 12px; border: 1px solid #e8eaed; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
        <div style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 56px; height: 56px; background: #fbbc04; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <span class="material-icons" style="font-size: 28px; color: white;">note</span>
            </div>
            <div>
                <h1 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 600; color: #202124;">My Notes</h1>
                <p style="margin: 0; color: #5f6368; font-size: 16px;">Create, organize, and manage your study notes</p>
            </div>
        </div>
        <div style="display: flex; gap: 12px;">
            <button onclick="createNewNote()" class="google-button">
                <span class="material-icons" style="font-size: 18px; margin-right: 8px;">add</span>
                New Note
            </button>
        </div>
    </div>
    
    <div style="display: flex; gap: 16px;">
        <div style="flex: 1;">
            <input type="text" id="searchNotes" class="google-input" placeholder="Search notes..." 
                   style="background: #f8f9fa; border: 1px solid #dadce0;">
        </div>
        <select id="filterSubject" class="google-input" style="width: 200px;">
            <option value="">All Subjects</option>
            {% for subject in subjects %}
            <option value="{{ subject.id }}">{{ subject.name }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<!-- Notes Grid -->
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
    {% for note in notes %}
    <div onclick="openNote({{ note.id }})" style="background: white; padding: 24px; border-radius: 12px; border: 1px solid #e8eaed; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.1);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)';">
        <div style="display: flex; align-items: center; margin-bottom: 16px;">
            <div style="width: 40px; height: 40px; background: #fbbc04; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                <span class="material-icons" style="font-size: 20px; color: white;">note</span>
            </div>
            <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: #202124; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ note.title }}</h3>
        </div>
        <div style="margin: 0 0 16px 0; color: #5f6368; font-size: 14px; line-height: 1.5; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;" class="markdown-content">{{ note.content[:150] }}{% if note.content|length > 150 %}...{% endif %}</div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e8eaed;">
            <span style="color: #5f6368; font-size: 12px; font-weight: 500;">{{ note.created_at if note.created_at else 'Recently' }}</span>
            <div style="display: flex; gap: 8px;">
                <button onclick="editNote({{ note.id }}, event)" class="google-button secondary" style="padding: 6px; min-width: auto;">
                    <span class="material-icons" style="font-size: 16px;">edit</span>
                </button>
                <button onclick="deleteNote({{ note.id }}, event)" class="google-button" style="background: #ea4335; padding: 6px; min-width: auto;">
                    <span class="material-icons" style="font-size: 16px;">delete</span>
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% if not notes %}
<div style="background: white; padding: 64px; text-align: center; border-radius: 12px; border: 1px solid #e8eaed; margin-top: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
    <div style="width: 80px; height: 80px; background: #fbbc04; border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
        <span class="material-icons" style="font-size: 40px; color: white;">note_add</span>
    </div>
    <h3 style="margin: 0 0 12px 0; color: #202124; font-size: 20px; font-weight: 600;">No notes yet</h3>
    <p style="margin: 0 0 24px 0; color: #5f6368; font-size: 14px;">Create your first note to get started with your studies</p>
    <button onclick="createNewNote()" class="google-button">
        <span class="material-icons" style="font-size: 18px; margin-right: 8px;">add</span>
        Create Your First Note
    </button>
</div>
{% endif %}

<!-- Note Editor Modal -->
<div id="noteEditorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; width: 90%; max-width: 800px; height: 80%; display: flex; flex-direction: column; box-shadow: 0 4px 24px rgba(0,0,0,0.15);">
        <div style="padding: 20px 24px; border-bottom: 1px solid #e8eaed; display: flex; align-items: center; justify-content: space-between; background: #f8f9fa; border-radius: 12px 12px 0 0;">
            <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Edit Note</h3>
            <div style="display: flex; gap: 8px;">
                <button onclick="saveNote()" class="google-button" style="padding: 8px 16px;">
                    <span class="material-icons" style="font-size: 16px; margin-right: 4px;">save</span>
                    Save
                </button>
                <button onclick="closeNoteEditor()" class="google-button secondary" style="padding: 8px 16px;">Cancel</button>
            </div>
        </div>
        
        <div style="flex: 1; padding: 24px; display: flex; flex-direction: column; overflow: hidden;">
            <div style="margin-bottom: 16px;">
                <input type="text" id="noteTitle" class="google-input" placeholder="Note title..." 
                       style="font-size: 18px; font-weight: 600;">
            </div>
            
            <div style="margin-bottom: 16px;">
                <select id="noteSubject" class="google-input" style="width: 200px;">
                    <option value="">Select Subject</option>
                    {% for subject in subjects %}
                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div style="flex: 1; display: flex; flex-direction: column;">
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <button onclick="insertImage()" class="google-button secondary" style="padding: 8px 12px;">
                        <span class="material-icons" style="font-size: 16px; margin-right: 4px;">image</span>
                        Add Image
                    </button>
                    <button onclick="toggleVoiceInput()" id="voiceInputBtn" class="google-button secondary" style="padding: 8px 12px;">
                        <span class="material-icons" style="font-size: 16px; margin-right: 4px;">mic</span>
                        Voice Input
                    </button>
                    <button onclick="extractTextFromImage()" class="google-button secondary" style="padding: 8px 12px;">
                        <span class="material-icons" style="font-size: 16px; margin-right: 4px;">text_fields</span>
                        Extract Text
                    </button>
                </div>
                
                <textarea id="noteContent" class="google-input" placeholder="Start writing your note... (Markdown supported: **bold**, *italic*, # headings, etc.)" 
                          style="flex: 1; resize: none; border: 1px solid #dadce0; border-radius: 8px; padding: 16px; font-family: 'Roboto', sans-serif; line-height: 1.5;"></textarea>
                <p style="margin: 8px 0 0 0; color: #5f6368; font-size: 12px;">
                    <span class="material-icons" style="font-size: 14px; vertical-align: middle;">info</span>
                    Markdown formatting supported for rich text
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Hidden file inputs -->
<input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
<input type="file" id="extractImageInput" accept="image/*" style="display: none;" onchange="handleExtractText(event)">

<script>
let currentNoteId = null;
let isRecording = false;
let mediaRecorder = null;
let audioChunks = [];

function createNewNote() {
    currentNoteId = null;
    document.getElementById('noteTitle').value = '';
    document.getElementById('noteContent').value = '';
    document.getElementById('noteSubject').value = '';
    document.getElementById('noteEditorModal').style.display = 'block';
}

function openNote(noteId) {
    // Implementation for opening existing note
    console.log('Opening note:', noteId);
}

function editNote(noteId, event) {
    event.stopPropagation();
    currentNoteId = noteId;
    // Load note data and open editor
    document.getElementById('noteEditorModal').style.display = 'block';
}

function deleteNote(noteId, event) {
    event.stopPropagation();
    if (confirm('Are you sure you want to delete this note?')) {
        fetch(`/delete_note/${noteId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting note');
            }
        });
    }
}

function saveNote() {
    const title = document.getElementById('noteTitle').value;
    const content = document.getElementById('noteContent').value;
    const subjectId = document.getElementById('noteSubject').value;
    
    if (!title.trim() || !content.trim()) {
        alert('Please fill in both title and content');
        return;
    }
    
    const url = currentNoteId ? `/update_note/${currentNoteId}` : '/create_note';
    const method = currentNoteId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            title: title,
            content: content,
            subject_id: subjectId || null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeNoteEditor();
            location.reload();
        } else {
            alert('Error saving note');
        }
    });
}

function closeNoteEditor() {
    document.getElementById('noteEditorModal').style.display = 'none';
}

function insertImage() {
    document.getElementById('imageInput').click();
}

function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Check file size (limit to 5MB for base64)
    if (file.size > 5 * 1024 * 1024) {
        alert('Image is too large. Please use an image smaller than 5MB.');
        event.target.value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        // Insert image as markdown with base64 data URL
        const textarea = document.getElementById('noteContent');
        const fileName = file.name || 'Image';
        const imageMarkdown = `\n![${fileName}](${e.target.result})\n`;
        
        // Insert at cursor position or at the end
        const cursorPos = textarea.selectionStart;
        const textBefore = textarea.value.substring(0, cursorPos);
        const textAfter = textarea.value.substring(cursorPos);
        textarea.value = textBefore + imageMarkdown + textAfter;
        
        // Move cursor after inserted image
        textarea.selectionStart = textarea.selectionEnd = cursorPos + imageMarkdown.length;
        textarea.focus();
        
        // Show success message with preview
        const notification = document.createElement('div');
        notification.style.cssText = 'position: fixed; bottom: 24px; right: 24px; background: #34a853; color: white; padding: 16px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10001; display: flex; align-items: center; gap: 12px; animation: slideInRight 0.3s;';
        notification.innerHTML = `
            <span class="material-icons">check_circle</span>
            <span>Image embedded successfully!</span>
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    };
    reader.readAsDataURL(file);
    
    // Reset file input
    event.target.value = '';
}

let recognition = null;

function toggleVoiceInput() {
    if (!isRecording) {
        startVoiceInput();
    } else {
        stopVoiceInput();
    }
}

function startVoiceInput() {
    // Check if browser supports Web Speech API
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('Sorry, your browser does not support real-time speech recognition.\n\nPlease use:\n• Chrome\n• Edge\n• Safari');
        return;
    }
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    
    // Configure for real-time recognition
    recognition.continuous = true;  // Keep listening
    recognition.interimResults = true;  // Show interim results in real-time
    recognition.lang = 'en-US';  // Set language
    
    const voiceBtn = document.getElementById('voiceInputBtn');
    const textarea = document.getElementById('noteContent');
    
    recognition.onstart = function() {
        isRecording = true;
        voiceBtn.innerHTML = '<span class="material-icons" style="font-size: 16px; margin-right: 4px; animation: pulse 1.5s infinite;">mic</span>Stop Recording';
        voiceBtn.style.background = '#ea4335';
        voiceBtn.style.color = 'white';
        
        // Show real-time recording indicator
        const indicator = document.createElement('div');
        indicator.id = 'voiceIndicator';
        indicator.style.cssText = 'position: fixed; top: 24px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #ea4335, #d32f2f); color: white; padding: 14px 24px; border-radius: 24px; box-shadow: 0 4px 16px rgba(234, 67, 53, 0.4); z-index: 10001; display: flex; align-items: center; gap: 12px; animation: slideDown 0.3s;';
        indicator.innerHTML = `
            <div style="width: 10px; height: 10px; background: white; border-radius: 50%; animation: pulse 1.5s infinite;"></div>
            <span style="font-weight: 600; font-size: 14px;">🎤 Listening... Speak now</span>
        `;
        document.body.appendChild(indicator);
    };
    
    recognition.onresult = function(event) {
        let interim = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            
            if (event.results[i].isFinal) {
                // Final result - add to textarea
                const cursorPos = textarea.selectionStart || textarea.value.length;
                const textBefore = textarea.value.substring(0, cursorPos);
                const textAfter = textarea.value.substring(cursorPos);
                textarea.value = textBefore + transcript + ' ' + textAfter;
                textarea.selectionStart = textarea.selectionEnd = cursorPos + transcript.length + 1;
                textarea.focus();
            } else {
                // Interim result - show in indicator
                interim = transcript;
                const indicator = document.getElementById('voiceIndicator');
                if (indicator && interim) {
                    indicator.innerHTML = `
                        <div style="width: 10px; height: 10px; background: white; border-radius: 50%; animation: pulse 1.5s infinite;"></div>
                        <span style="font-weight: 600; font-size: 14px;">🎤 ${interim}...</span>
                    `;
                }
            }
        }
    };
    
    recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        if (event.error !== 'no-speech' && event.error !== 'aborted') {
            stopVoiceInput();
            alert('Speech recognition error: ' + event.error);
        }
    };
    
    recognition.onend = function() {
        if (isRecording) {
            // Auto-restart if still recording
            try {
                recognition.start();
            } catch (e) {
                stopVoiceInput();
            }
        }
    };
    
    try {
        recognition.start();
    } catch (e) {
        alert('Error starting speech recognition: ' + e);
    }
}

function stopVoiceInput() {
    if (recognition) {
        isRecording = false;
        recognition.stop();
        recognition = null;
        
        const voiceBtn = document.getElementById('voiceInputBtn');
        voiceBtn.innerHTML = '<span class="material-icons" style="font-size: 16px; margin-right: 4px;">mic</span>Voice Input';
        voiceBtn.style.background = '';
        voiceBtn.style.color = '';
        
        // Remove indicator with animation
        const indicator = document.getElementById('voiceIndicator');
        if (indicator) {
            indicator.style.opacity = '0';
            indicator.style.transform = 'translateX(-50%) translateY(-20px)';
            indicator.style.transition = 'all 0.3s';
            setTimeout(() => indicator.remove(), 300);
        }
    }
}

function extractTextFromImage() {
    document.getElementById('extractImageInput').click();
}

async function handleExtractText(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Show loading notification
    const loadingNotif = document.createElement('div');
    loadingNotif.id = 'extractLoading';
    loadingNotif.style.cssText = 'position: fixed; bottom: 24px; right: 24px; background: #1a73e8; color: white; padding: 16px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10001; display: flex; align-items: center; gap: 12px;';
    loadingNotif.innerHTML = `
        <div style="width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <span>Extracting text from image...</span>
    `;
    document.body.appendChild(loadingNotif);
    
    const textarea = document.getElementById('noteContent');
    const formData = new FormData();
    formData.append('image', file);
    
    try {
        const response = await fetch('/extract_text_from_image', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        loadingNotif.remove();
        
        if (data.success && data.extracted_text) {
            // Insert extracted text at cursor position
            const cursorPos = textarea.selectionStart || 0;
            const textBefore = textarea.value.substring(0, cursorPos);
            const textAfter = textarea.value.substring(cursorPos);
            
            const extractedText = data.extracted_text.trim();
            textarea.value = textBefore + '\n\n' + extractedText + '\n\n' + textAfter;
            
            // Move cursor after inserted text
            const newPos = cursorPos + extractedText.length + 4;
            textarea.selectionStart = textarea.selectionEnd = newPos;
            textarea.focus();
            
            // Show success notification
            const successNotif = document.createElement('div');
            successNotif.style.cssText = 'position: fixed; bottom: 24px; right: 24px; background: #34a853; color: white; padding: 16px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10001; display: flex; align-items: center; gap: 12px;';
            successNotif.innerHTML = `
                <span class="material-icons">check_circle</span>
                <span>Text extracted and added to note!</span>
            `;
            document.body.appendChild(successNotif);
            
            setTimeout(() => {
                successNotif.style.opacity = '0';
                successNotif.style.transform = 'translateX(100%)';
                successNotif.style.transition = 'all 0.3s';
                setTimeout(() => successNotif.remove(), 300);
            }, 3000);
        } else {
            alert('Error extracting text: ' + (data.error || 'Could not extract text from image. Make sure the image contains readable text.'));
        }
    } catch (error) {
        loadingNotif.remove();
        alert('Error extracting text: ' + error);
    } finally {
        // Reset file input
        event.target.value = '';
    }
}

// Search functionality
document.getElementById('searchNotes').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const noteCards = document.querySelectorAll('[onclick*="openNote"]');
    
    noteCards.forEach(card => {
        const title = card.querySelector('h3').textContent.toLowerCase();
        const content = card.querySelector('p').textContent.toLowerCase();
        
        if (title.includes(searchTerm) || content.includes(searchTerm)) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
});

// Subject filter
document.getElementById('filterSubject').addEventListener('change', function(e) {
    // Implementation for subject filtering
    console.log('Filter by subject:', e.target.value);
});
</script>
{% endblock %}