{% extends "base.html" %}

{% block title %}Chat{% endblock %}

{% block content %}
<div style="max-width: 1000px; margin: 0 auto; height: calc(100vh - 120px); display: flex; flex-direction: column; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e8eaed;">
    <div style="background: #1a73e8; padding: 24px; color: white;">
        <div style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <span class="material-icons" style="font-size: 24px;">chat</span>
            </div>
            <div>
                <h1 style="margin: 0 0 4px 0; font-size: 24px; font-weight: 600;">Study Assistant</h1>
                <p style="margin: 0; color: rgba(255,255,255,0.8); font-size: 14px;">Ask questions about your study materials</p>
            </div>
        </div>
    </div>
    <div style="flex: 1; background: #f8f9fa; padding: 24px; overflow-y: auto;" id="chatContainer">
        {% if chat_history %}
            {% for entry in chat_history %}
                <div class="chat-message user-message" style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
                    <div style="max-width: 70%; background: #1a73e8; color: white; padding: 16px 20px; border-radius: 18px 18px 4px 18px;">
                        <p style="margin: 0; font-size: 14px; line-height: 1.5;">{{ entry.question }}</p>
                    </div>
                </div>
                <div class="chat-message ai-message" style="display: flex; justify-content: flex-start; margin-bottom: 24px;">
                    <div style="max-width: 80%; background: white; padding: 16px 20px; border-radius: 18px 18px 18px 4px; border: 1px solid #e8eaed;">
                        <div style="display: flex; align-items: center; margin-bottom: 12px;">
                            <div style="width: 32px; height: 32px; background: #34a853; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 8px;">
                                <span class="material-icons" style="font-size: 16px; color: white;">smart_toy</span>
                            </div>
                            <span style="font-size: 12px; font-weight: 500; color: #5f6368;">AI Assistant</span>
                        </div>
                        <div style="font-size: 14px; line-height: 1.6; color: #202124; white-space: pre-wrap; word-wrap: break-word;">
                            {{ entry.answer }}
                        </div>
                        {% if entry.sources %}
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e8eaed;">
                                <p style="margin: 0 0 8px 0; font-size: 12px; font-weight: 500; color: #5f6368;">Sources:</p>
                                {% for source in entry.sources %}
                                    <div style="background: #f8f9fa; padding: 8px 12px; border-radius: 8px; margin-bottom: 4px; border: 1px solid #e8eaed;">
                                        <span style="color: #1a73e8; font-weight: 500; font-size: 12px;">{{ source.metadata.file }}</span>
                                        <span style="color: #5f6368; margin-left: 8px; font-size: 11px;">({{ "%.1f"|format(source.score * 100) }}%)</span>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div id="welcomeMessage" style="display: flex; justify-content: center; align-items: center; height: 100%; text-align: center;">
                <div>
                    <div style="width: 80px; height: 80px; background: #1a73e8; border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
                        <span class="material-icons" style="font-size: 40px; color: white;">smart_toy</span>
                    </div>
                    <h3 style="margin: 0 0 12px 0; font-size: 20px; font-weight: 600; color: #202124;">Welcome to Study Assistant!</h3>
                    <p style="margin: 0; color: #5f6368; font-size: 14px;">Ask me anything about your study materials.</p>
                </div>
            </div>
        {% endif %}
        <div id="loadingMessage" style="display: none; justify-content: flex-start; margin-bottom: 24px;">
            <div style="max-width: 80%; background: white; padding: 16px 20px; border-radius: 18px 18px 18px 4px; border: 1px solid #e8eaed;">
                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    <div style="width: 32px; height: 32px; background: #34a853; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 8px;">
                        <span class="material-icons" style="font-size: 16px; color: white;">smart_toy</span>
                    </div>
                    <span style="font-size: 12px; font-weight: 500; color: #5f6368;">AI Assistant</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="display: flex; gap: 3px;">
                        <div style="width: 6px; height: 6px; background: #1a73e8; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out;"></div>
                        <div style="width: 6px; height: 6px; background: #1a73e8; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; animation-delay: 0.2s;"></div>
                        <div style="width: 6px; height: 6px; background: #1a73e8; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; animation-delay: 0.4s;"></div>
                    </div>
                    <span style="font-size: 14px; color: #5f6368; font-weight: 500;">Thinking...</span>
                </div>
            </div>
        </div>
    </div>
    <div style="background: white; padding: 24px; border-top: 1px solid #e8eaed;">
        <form method="POST" style="display: flex; gap: 12px; align-items: flex-end;" id="chatForm">
            <div style="flex: 1;">
                <textarea name="question" rows="2" required placeholder="Ask a question about your materials..." 
                          style="width: 100%; padding: 12px 16px; background: #ffffff; border: 1px solid #dadce0; border-radius: 8px; font-size: 14px; font-family: inherit; line-height: 1.5; resize: none; outline: none;"
                          id="questionInput"></textarea>
            </div>
            <button type="button" id="voiceToggleBtn" 
                    style="background: #f8f9fa; color: #5f6368; border: 1px solid #dadce0; border-radius: 8px; padding: 12px 16px; font-size: 14px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 6px;"
                    title="Enable voice conversation">
                <span id="voiceText">Voice</span>
            </button>
            <button type="submit" id="askBtn" 
                    style="background: #1a73e8; color: white; border: none; border-radius: 8px; padding: 12px 20px; font-size: 14px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <span id="btnText">Send</span>
                <span class="material-icons" style="font-size: 16px;">send</span>
            </button>
        </form>
    </div>
</div>

<style>
@keyframes bounce {
    0%, 80%, 100% { 
        transform: scale(0);
    } 
    40% { 
        transform: scale(1);
    }
}

#questionInput:focus {
    border-color: #1a73e8;
    box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
}

#askBtn:hover {
    background: #1557b0;
}
</style>

<script>
function addUserMessage(question) {
    const chatContainer = document.getElementById('chatContainer');
    const welcomeMsg = document.getElementById('welcomeMessage');
    if (welcomeMsg) {
        welcomeMsg.remove();
    }
    const userMsgDiv = document.createElement('div');
    userMsgDiv.className = 'chat-message user-message';
    userMsgDiv.style.cssText = 'display: flex; justify-content: flex-end; margin-bottom: 16px;';
    userMsgDiv.innerHTML = `
        <div style="max-width: 70%; background: #1a73e8; color: white; padding: 16px 20px; border-radius: 18px 18px 4px 18px;">
            <p style="margin: 0; font-size: 14px; line-height: 1.5;">${escapeHtml(question)}</p>
        </div>
    `;
    chatContainer.appendChild(userMsgDiv);
}

function addAIMessage(answer, sources) {
    const chatContainer = document.getElementById('chatContainer');
    const aiMsgDiv = document.createElement('div');
    aiMsgDiv.className = 'chat-message ai-message';
    aiMsgDiv.style.cssText = 'display: flex; justify-content: flex-start; margin-bottom: 24px;';
    
    let sourcesHtml = '';
    if (sources && sources.length > 0) {
        sourcesHtml = `
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e8eaed;">
                <p style="margin: 0 0 8px 0; font-size: 12px; font-weight: 500; color: #5f6368;">Sources:</p>
                ${sources.map(s => `
                    <div style="background: #f8f9fa; padding: 8px 12px; border-radius: 8px; margin-bottom: 4px; border: 1px solid #e8eaed;">
                        <span style="color: #1a73e8; font-weight: 500; font-size: 12px;">${escapeHtml(s.metadata?.file || 'Unknown')}</span>
                        <span style="color: #5f6368; margin-left: 8px; font-size: 11px;">(${(s.score * 100).toFixed(1)}%)</span>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    aiMsgDiv.innerHTML = `
        <div style="max-width: 80%; background: white; padding: 16px 20px; border-radius: 18px 18px 18px 4px; border: 1px solid #e8eaed;">
            <div style="display: flex; align-items: center; margin-bottom: 12px;">
                <div style="width: 32px; height: 32px; background: #34a853; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 8px;">
                    <span class="material-icons" style="font-size: 16px; color: white;">smart_toy</span>
                </div>
                <span style="font-size: 12px; font-weight: 500; color: #5f6368;">AI Assistant</span>
            </div>
            <div style="font-size: 14px; line-height: 1.6; color: #202124; white-space: pre-wrap; word-wrap: break-word;">
                ${escapeHtml(answer)}
            </div>
            ${sourcesHtml}
        </div>
    `;
    chatContainer.appendChild(aiMsgDiv);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function scrollToBottom() {
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function submitQuestion() {
    const btn = document.getElementById('askBtn');
    const btnText = document.getElementById('btnText');
    const loadingMessage = document.getElementById('loadingMessage');
    const chatContainer = document.getElementById('chatContainer');
    const questionInput = document.getElementById('questionInput');
    const question = questionInput.value.trim();
    if (!question) {
        return;
    }
    if (btn.disabled) {
        return;
    }
    btn.disabled = true;
    btnText.textContent = 'Sending...';
    addUserMessage(question);
    questionInput.value = '';
    questionInput.style.height = 'auto';
    scrollToBottom();
    setTimeout(() => {
        if (loadingMessage) {
            if (loadingMessage.parentNode) {
                loadingMessage.parentNode.removeChild(loadingMessage);
            }
            loadingMessage.style.display = 'flex';
            if (chatContainer) {
                chatContainer.appendChild(loadingMessage);
            }
        }
        scrollToBottom();
    }, 50);
    const formData = new FormData();
    formData.append('question', question);
    const timeoutPromise = new Promise((_, reject) => {
        setTimeout(() => {
            reject(new Error('Request timeout after 30 seconds'));
        }, 30000);
    });
    Promise.race([
        fetch('/chat', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        }),
        timeoutPromise
    ])
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json().catch(() => {
            throw new Error('Invalid JSON response');
        });
    })
    .then(data => {
        if (!data || !data.success) {
            throw new Error(data?.error || 'Unknown error');
        }
        if (loadingMessage) {
            if (loadingMessage.parentNode) {
                loadingMessage.parentNode.removeChild(loadingMessage);
            }
            loadingMessage.style.display = 'none';
        }
        addAIMessage(data.answer, data.sources);
        btn.disabled = false;
        btnText.textContent = 'Send';
        scrollToBottom();
        if (window.voiceEnabled) {
            speakText(data.answer);
            if (recognition && voiceEnabled) {
                setTimeout(() => {
                    if (!isListening) {
                        startVoiceInput();
                    }
                }, 1000);
            }
        }
    })
    .catch(error => {
        if (loadingMessage && loadingMessage.parentNode) {
            loadingMessage.parentNode.removeChild(loadingMessage);
        }
        if (loadingMessage) {
            loadingMessage.style.display = 'none';
        }
        btn.disabled = false;
        btnText.textContent = 'Send';
        alert('Error sending question: ' + error.message);
    });
}

document.getElementById('chatForm').addEventListener('submit', function(e) {
    e.preventDefault();
    submitQuestion();
});

document.getElementById('questionInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('chatForm').dispatchEvent(new Event('submit'));
    }
});
scrollToBottom();

let voiceEnabled = false;
let currentSpeech = null;
let recognition = null;
let isListening = false;

function speakText(text) {
    if ('speechSynthesis' in window) {
        if (currentSpeech) {
            window.speechSynthesis.cancel();
        }
        const utterance = new SpeechSynthesisUtterance(text);
        const voices = window.speechSynthesis.getVoices();
        const maleVoice = voices.find(voice => 
            voice.name.toLowerCase().includes('male') || 
            voice.name.toLowerCase().includes('david') ||
            voice.name.toLowerCase().includes('daniel') ||
            voice.name.toLowerCase().includes('james') ||
            (voice.lang.startsWith('en') && voice.gender === 'male')
        ) || voices.find(voice => voice.lang.startsWith('en-US') && !voice.name.toLowerCase().includes('female')) || voices.find(voice => voice.lang.startsWith('en'));
        if (maleVoice) {
            utterance.voice = maleVoice;
        }
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;
        utterance.onend = function() {
            currentSpeech = null;
        };
        utterance.onerror = function() {
            currentSpeech = null;
        };
        currentSpeech = utterance;
        window.speechSynthesis.speak(utterance);
    }
}

function stopSpeaking() {
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        currentSpeech = null;
    }
}

document.getElementById('voiceToggleBtn').addEventListener('click', function() {
    voiceEnabled = !voiceEnabled;
    const btn = document.getElementById('voiceToggleBtn');
    const voiceText = document.getElementById('voiceText');
    if (voiceEnabled) {
        btn.style.background = '#1a73e8';
        btn.style.color = 'white';
        btn.style.borderColor = '#1a73e8';
        voiceText.textContent = 'Voice ON';
        window.voiceEnabled = true;
        if (recognition && !isListening) {
            startVoiceInput();
        }
    } else {
        btn.style.background = '#f8f9fa';
        btn.style.color = '#5f6368';
        btn.style.borderColor = '#dadce0';
        voiceText.textContent = 'Voice';
        window.voiceEnabled = false;
        stopSpeaking();
        stopVoiceInput();
    }
});

if ('speechSynthesis' in window) {
    window.speechSynthesis.getVoices();
    window.addEventListener('voiceschanged', function() {
        window.speechSynthesis.getVoices();
    });
}

if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'en-US';

    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        const questionInput = document.getElementById('questionInput');
        questionInput.value = transcript;
        isListening = false;
        recognition.stop();
        setTimeout(() => {
            submitQuestion();
        }, 100);
    };

    recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        stopVoiceInput();
        if (event.error !== 'no-speech' && event.error !== 'aborted') {
            alert('Speech recognition error: ' + event.error);
        }
    };

    recognition.onend = function() {
        if (voiceEnabled && !isListening) {
            setTimeout(() => {
                if (voiceEnabled && !isListening) {
                    try {
                        isListening = true;
                        recognition.start();
                    } catch (e) {
                        isListening = false;
                    }
                }
            }, 100);
        }
    };

} else {
    document.getElementById('voiceToggleBtn').style.display = 'none';
}

function startVoiceInput() {
    if (recognition && !isListening && voiceEnabled) {
        try {
            isListening = true;
            recognition.start();
            const questionInput = document.getElementById('questionInput');
            questionInput.placeholder = 'Listening...';
        } catch (e) {
            console.error('Error starting recognition:', e);
            isListening = false;
        }
    }
}

function stopVoiceInput() {
    if (recognition && isListening) {
        isListening = false;
        try {
            recognition.stop();
        } catch (e) {
            console.error('Error stopping recognition:', e);
        }
        const questionInput = document.getElementById('questionInput');
        questionInput.placeholder = 'Ask a question about your materials...';
    }
}
</script>
{% endblock %}